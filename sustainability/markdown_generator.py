from typing import Dict, Any, List, Optional
from datetime import datetime
import json
import re

class MarkdownFormatter:
    """Advanced markdown formatter for comprehensive sustainability training content"""
    
    def __init__(self, session_id: str):
        self.session_id = session_id
        self.generation_timestamp = datetime.now()
        self.content_sections = []
        self.toc_items = []
        
    def generate_comprehensive_markdown(self, 
                                      extracted_data: Dict[str, Any], 
                                      validation_result: Dict[str, Any],
                                      integration_result: Dict[str, Any],
                                      training_request: Dict[str, Any]) -> str:
        """Generate comprehensive markdown from all extracted task data"""
        
        # Extract individual task data
        scenario_data = extracted_data.get("scenario_data", {})
        problematic_data = extracted_data.get("problematic_messages", {})
        corrected_data = extracted_data.get("corrected_messages", {})
        playbook_data = extracted_data.get("playbook_data", {})
        
        # Build comprehensive content
        content_parts = []
        
        # Header and metadata
        content_parts.append(self._generate_header(scenario_data, training_request, validation_result))
        
        # Table of contents
        content_parts.append(self._generate_table_of_contents())
        
        # Executive summary
        content_parts.append(self._generate_executive_summary(scenario_data, playbook_data, validation_result))
        
        # Business scenario (detailed)
        content_parts.append(self._generate_business_scenario_section(scenario_data))
        
        # Problematic messaging analysis (comprehensive)
        content_parts.append(self._generate_problematic_analysis_section(problematic_data, scenario_data))
        
        # Best practice corrections (detailed)
        content_parts.append(self._generate_corrections_section(corrected_data, problematic_data, scenario_data))
        
        # Integrated message examples
        content_parts.append(self._generate_integrated_examples_section(integration_result))
        
        # Frameworks and tools (enhanced)
        content_parts.append(self._generate_frameworks_section(playbook_data, corrected_data))
        
        # Compliance and validation
        content_parts.append(self._generate_compliance_section(playbook_data, training_request))
        
        # Case studies (rich examples)
        content_parts.append(self._generate_case_studies_section(playbook_data, problematic_data))
        
        # Implementation guide
        content_parts.append(self._generate_implementation_section(playbook_data, scenario_data))
        
        # Regulatory reference
        content_parts.append(self._generate_regulatory_section(playbook_data, training_request))
        
        # Quality metrics and session info
        content_parts.append(self._generate_quality_metrics_section(validation_result, extracted_data))
        
        # Appendices
        content_parts.append(self._generate_appendices_section(playbook_data, extracted_data))
        
        # Join all parts
        return "\n\n".join(content_parts)
    
    def _generate_header(self, scenario_data: Dict[str, Any], training_request: Dict[str, Any], validation: Dict[str, Any]) -> str:
        """Generate comprehensive document header"""
        company_name = scenario_data.get("company_name", "Your Organization")
        industry = training_request.get("industry_focus", "Business")
        framework = training_request.get("regulatory_framework", "Global")
        
        quality_emoji = "üü¢" if validation.get("quality_score", 0) >= 80 else "üü°" if validation.get("quality_score", 0) >= 60 else "üî¥"
        
        return f"""# Comprehensive Sustainability Messaging Playbook
## {company_name} - {industry} Industry Guide

**üéØ Regulatory Framework:** {framework}  
**üìä Training Level:** {training_request.get("training_level", "Intermediate")}  
**ü§ñ Generated by:** Sustainability Training AI  
**üìÖ Created:** {self.generation_timestamp.strftime('%Y-%m-%d %H:%M:%S')}  
**üÜî Session ID:** {self.session_id}  
**‚≠ê Quality Score:** {validation.get("quality_score", 0):.1f}/100 {quality_emoji}  
**üìà Data Completeness:** {validation.get("completeness_percentage", 0):.1f}%

---

> **üå± AI-Powered Sustainability Communications Training**  
> This comprehensive playbook provides industry-specific guidance for creating compliant, effective sustainability messaging based on current regulatory requirements and best practices.

---"""

    def _generate_table_of_contents(self) -> str:
        """Generate dynamic table of contents"""
        return """## üìã Table of Contents

1. [üìä Executive Summary](#executive-summary)
2. [üè¢ Business Scenario Analysis](#business-scenario-analysis)
3. [üö® Problematic Messaging Analysis](#problematic-messaging-analysis)
4. [‚úÖ Best Practice Corrections](#best-practice-corrections)
5. [üîó Integrated Message Examples](#integrated-message-examples)
6. [üõ†Ô∏è Frameworks and Validation Tools](#frameworks-and-validation-tools)
7. [‚úÖ Compliance Guidelines](#compliance-guidelines)
8. [üìñ Case Study Library](#case-study-library)
9. [üöÄ Implementation Roadmap](#implementation-roadmap)
10. [üìÑ Regulatory Reference Guide](#regulatory-reference-guide)
11. [üìä Quality Metrics & Session Data](#quality-metrics-session-data)
12. [üìö Appendices](#appendices)

---"""

    def _generate_executive_summary(self, scenario_data: Dict[str, Any], playbook_data: Dict[str, Any], validation: Dict[str, Any]) -> str:
        """Generate comprehensive executive summary"""
        company_name = scenario_data.get("company_name", "Your Organization")
        industry = scenario_data.get("industry", "your industry")
        
        summary_text = playbook_data.get("executive_summary", "")
        if not summary_text:
            summary_text = f"This comprehensive playbook provides {company_name} with detailed guidance for creating compliant sustainability messaging in the {industry} sector."
        
        return f"""## üìä Executive Summary

{summary_text}

### üéØ Key Training Outcomes

**For {company_name}:**
- ‚úÖ **Industry-Specific Guidance** - Tailored recommendations for {industry} sector
- ‚úÖ **Regulatory Compliance** - Current requirements and enforcement trends
- ‚úÖ **Risk Mitigation** - Identification and correction of problematic messaging patterns
- ‚úÖ **Best Practice Implementation** - Proven frameworks and validation tools
- ‚úÖ **Team Training Resources** - Ready-to-use materials for staff education

### üìà Playbook Quality Metrics

- **üéØ Content Accuracy:** {validation.get('quality_score', 0):.1f}/100
- **üìä Data Completeness:** {validation.get('completeness_percentage', 0):.1f}%
- **üîç Validation Checks:** {len(validation.get('task_validations', {}))} comprehensive reviews
- **‚ö†Ô∏è Issues Identified:** {len(validation.get('overall_issues', []))} areas for attention
- **üí™ Strengths Found:** {sum(len(v.get('strengths', [])) for v in validation.get('task_validations', {}).values())} best practices

### üöÄ Immediate Action Items

1. **Review Business Scenario** - Understand your specific context and challenges
2. **Analyze Problematic Patterns** - Identify risks in current messaging
3. **Implement Corrections** - Apply validated improvements to communications
4. **Deploy Frameworks** - Use validation tools for ongoing compliance
5. **Train Your Team** - Share resources and conduct workshops

---"""

    def _generate_business_scenario_section(self, scenario_data: Dict[str, Any]) -> str:
        """Generate detailed business scenario section"""
        if not scenario_data:
            return "## üè¢ Business Scenario Analysis\n\n*No business scenario data available*\n\n---"
        
        company_name = scenario_data.get("company_name", "Company Name")
        
        content = f"""## üè¢ Business Scenario Analysis
### {company_name} - Sustainability Messaging Context

#### üè™ Company Profile

**Company Name:** {scenario_data.get("company_name", "N/A")}  
**Industry Sector:** {scenario_data.get("industry", "N/A")}  
**Organization Size:** {scenario_data.get("company_size", "N/A")}  
**Primary Location:** {scenario_data.get("location", "N/A")}  

#### üéØ Products & Services

{scenario_data.get("product_service", "Product and service information not available")}

#### üë• Target Market Analysis

**Primary Audience:** {scenario_data.get("target_audience", "Target audience not specified")}

#### üìà Marketing Objectives"""
        
        marketing_objectives = scenario_data.get("marketing_objectives", [])
        if marketing_objectives:
            content += "\n\n" + self._format_list_items(marketing_objectives)
        else:
            content += "\n\n*No specific marketing objectives defined*"
        
        content += f"""

#### üå± Sustainability Context & Challenges

{scenario_data.get("sustainability_context", "Sustainability context not provided")}

#### üìã Preliminary Sustainability Claims Under Review"""
        
        preliminary_claims = scenario_data.get("preliminary_claims", [])
        if preliminary_claims:
            content += "\n\n" + self._format_list_items(preliminary_claims, "‚ö†Ô∏è")
        else:
            content += "\n\n*No preliminary claims specified*"
        
        content += f"""

#### ‚öñÔ∏è Regulatory Compliance Context

{scenario_data.get("regulatory_context", "Regulatory context not specified")}"""
        
        # Add additional context if available
        if scenario_data.get("competitive_landscape"):
            content += f"""

#### üèÜ Competitive Landscape

{scenario_data["competitive_landscape"]}"""
        
        if scenario_data.get("current_practices"):
            content += f"""

#### üîÑ Current Sustainability Practices

{self._format_list_items(scenario_data["current_practices"], "‚úÖ")}"""
        
        if scenario_data.get("challenges_faced"):
            content += f"""

#### ‚ö†Ô∏è Key Challenges Identified

{self._format_list_items(scenario_data["challenges_faced"], "üî∏")}"""
        
        # Research sources
        research_sources = scenario_data.get("market_research_sources", [])
        if research_sources:
            content += f"""

#### üìö Market Research Sources

{self._format_list_items(research_sources, "üîó")}"""
        
        content += "\n\n---"
        return content

    def _generate_problematic_analysis_section(self, problematic_data: Dict[str, Any], scenario_data: Dict[str, Any]) -> str:
        """Generate comprehensive problematic messaging analysis"""
        if not problematic_data:
            return "## üö® Problematic Messaging Analysis\n\n*No problematic messaging data available*\n\n---"
        
        company_name = scenario_data.get("company_name", "the company")
        
        content = f"""## üö® Problematic Messaging Analysis
### Identifying Greenwashing Risks for {company_name}

#### üéØ Analysis Overview

**Scenario Reference:** {problematic_data.get("scenario_reference", "Not specified")}

#### üåç Current Regulatory Landscape

{problematic_data.get("regulatory_landscape", "Regulatory landscape information not available")}"""
        
        # Industry-specific insights
        if problematic_data.get("industry_specific_insights"):
            content += f"""

#### üè≠ Industry-Specific Compliance Insights

{problematic_data["industry_specific_insights"]}"""
        
        # Enforcement trends
        enforcement_trends = problematic_data.get("enforcement_trends", [])
        if enforcement_trends:
            content += f"""

#### üìà Current Enforcement Trends

{self._format_list_items(enforcement_trends, "‚ö°")}"""
        
        content += """

### ‚ö†Ô∏è Problematic Message Examples & Analysis"""
        
        problematic_messages = problematic_data.get("problematic_messages", [])
        
        for i, message in enumerate(problematic_messages, 1):
            content += f"""

#### ‚ùå Problematic Message #{i}

**Problematic Statement:**
> "{message.get('message', 'Message not available')}"

**üîç Problems Identified:**
{self._format_list_items(message.get('problems_identified', []), "üî∏")}

**‚öñÔ∏è Regulatory Violations:**
{self._format_list_items(message.get('regulatory_violations', []), "‚öñÔ∏è")}

**üö´ Greenwashing Patterns Demonstrated:**
{self._format_list_items(message.get('greenwashing_patterns', []), "üö´")}

**üìã Detailed Analysis:**
{message.get('why_problematic', 'Analysis not available')}

**üè¢ Real-World Examples:**
{self._format_list_items(message.get('real_world_examples', []), "üì∞")}

**‚ö†Ô∏è Potential Consequences:**
{self._format_list_items(message.get('potential_consequences', []), "‚ö†Ô∏è")}"""
            
            # Context-specific issues
            if message.get('context_specific_issues'):
                content += f"""

**üéØ Context-Specific Issues for {company_name}:**
{message['context_specific_issues']}"""
            
            # Alternative approaches
            alternative_approaches = message.get('alternative_approaches', [])
            if alternative_approaches:
                content += f"""

**üí° Initial Improvement Suggestions:**
{self._format_list_items(alternative_approaches, "üí°")}"""
        
        # General patterns
        general_patterns = problematic_data.get("general_patterns_found", [])
        if general_patterns:
            content += f"""

### üîç Common Greenwashing Patterns Identified

{self._format_list_items(general_patterns, "üî∏")}"""
        
        # Research sources
        research_sources = problematic_data.get("research_sources", [])
        if research_sources:
            content += f"""

### üìö Analysis Sources & References

{self._format_list_items(research_sources, "üîó")}"""
        
        content += "\n\n---"
        return content

    def _generate_corrections_section(self, corrected_data: Dict[str, Any], problematic_data: Dict[str, Any], scenario_data: Dict[str, Any]) -> str:
        """Generate comprehensive corrections section"""
        if not corrected_data:
            return "## ‚úÖ Best Practice Corrections\n\n*No correction data available*\n\n---"
        
        company_name = scenario_data.get("company_name", "your organization")
        
        content = f"""## ‚úÖ Best Practice Corrections
### Transforming Problematic Messages into Compliant Communications

#### üéØ Correction Methodology for {company_name}

**Scenario Context:** {corrected_data.get("scenario_reference", "Not specified")}

This section provides specific, validated improvements to the problematic messages identified above, ensuring compliance with current regulations while maintaining marketing effectiveness."""
        
        corrected_messages = corrected_data.get("corrected_messages", [])
        
        for i, correction in enumerate(corrected_messages, 1):
            original_id = correction.get("original_message_id", str(i))
            
            content += f"""

### ‚úÖ Correction #{i} (Message {original_id})

**üîÑ Improved Message:**
> "{correction.get('corrected_message', 'Corrected message not available')}"

**üõ†Ô∏è Specific Changes Made:**
{self._format_list_items(correction.get('changes_made', []), "üîß")}

**‚öñÔ∏è Compliance Notes:**
{correction.get('compliance_notes', 'Compliance information not available')}

**üíé Best Practices Applied:**
{self._format_list_items(correction.get('best_practices_applied', []), "‚≠ê")}

**üè¢ Companies Using Similar Effective Messaging:**
{self._format_list_items(correction.get('real_world_examples', []), "üìà")}

**üéØ Why This Correction Works:**
{correction.get('effectiveness_rationale', 'Effectiveness explanation not available')}"""
            
            # Evidence required
            evidence_required = correction.get('evidence_required', [])
            if evidence_required:
                content += f"""

**üìä Evidence Required to Support This Claim:**
{self._format_list_items(evidence_required, "üìã")}"""
            
            # Monitoring suggestions
            monitoring_suggestions = correction.get('monitoring_suggestions', [])
            if monitoring_suggestions:
                content += f"""

**üìä Monitoring & Measurement Recommendations:**
{self._format_list_items(monitoring_suggestions, "üìä")}"""
        
        # General guidelines
        general_guidelines = corrected_data.get("general_guidelines", [])
        if general_guidelines:
            content += f"""

### üìã General Messaging Guidelines

{self._format_list_items(general_guidelines, "‚úÖ")}"""
        
        # Key principles
        key_principles = corrected_data.get("key_principles", [])
        if key_principles:
            content += f"""

### üéØ Key Principles for Effective Sustainability Communication

{self._format_list_items(key_principles, "üåü")}"""
        
        # Regulatory compliance tips
        compliance_tips = corrected_data.get("regulatory_compliance_tips", [])
        if compliance_tips:
            content += f"""

### ‚öñÔ∏è Regulatory Compliance Tips

{self._format_list_items(compliance_tips, "‚öñÔ∏è")}"""
        
        # Industry-specific advice
        industry_advice = corrected_data.get("industry_specific_advice", "")
        if industry_advice:
            content += f"""

### üè≠ Industry-Specific Advice

{industry_advice}"""
        
        # Implementation roadmap
        implementation_roadmap = corrected_data.get("implementation_roadmap", [])
        if implementation_roadmap:
            content += f"""

### üó∫Ô∏è Implementation Roadmap

{self._format_list_items(implementation_roadmap, "üìç")}"""
        
        # Success metrics
        success_metrics = corrected_data.get("success_metrics", [])
        if success_metrics:
            content += f"""

### üìä Success Metrics & KPIs

{self._format_list_items(success_metrics, "üìà")}"""
        
        # Research sources
        research_sources = corrected_data.get("research_sources", [])
        if research_sources:
            content += f"""

### üìö Best Practice Sources & References

{self._format_list_items(research_sources, "üîó")}"""
        
        content += "\n\n---"
        return content

    def _generate_integrated_examples_section(self, integration_result: Dict[str, Any]) -> str:
        """Generate integrated message examples section"""
        if not integration_result or not integration_result.get("integrated_messages"):
            return "## üîó Integrated Message Examples\n\n*No integrated examples available*\n\n---"
        
        content = """## üîó Integrated Message Examples
### Before & After Comparisons with Full Context

This section shows the complete transformation journey from problematic messaging to compliant alternatives, demonstrating the practical application of best practices."""
        
        integrated_messages = integration_result.get("integrated_messages", [])
        
        for pair in integrated_messages:
            pair_id = pair.get("pair_id", "Unknown")
            problematic = pair.get("problematic", {})
            correction = pair.get("correction", {})
            
            content += f"""

### üîÑ Message Transformation #{pair_id}

#### ‚ùå BEFORE: Problematic Version
**Message:** "{problematic.get('message', 'Not available')}"

**Issues:** {', '.join(problematic.get('problems_identified', []))}

#### ‚úÖ AFTER: Compliant Version"""
            
            if correction:
                content += f"""
**Message:** "{correction.get('corrected_message', 'Not available')}"

**Key Improvements:** {', '.join(correction.get('changes_made', []))}

**Compliance Status:** {correction.get('compliance_notes', 'Not specified')}"""
            else:
                content += """
**Status:** ‚ö†Ô∏è Correction pending - requires additional development"""
            
            # Integration quality indicator
            if pair.get("integration_complete"):
                content += "\n\n**‚úÖ Integration Quality:** Complete transformation with full compliance validation"
            else:
                content += "\n\n**‚ö†Ô∏è Integration Quality:** Requires additional refinement"
        
        # Cross-reference quality
        cross_refs = integration_result.get("cross_references", {})
        if cross_refs:
            content += f"""

### üîó Cross-Reference Analysis

**Scenario Integration:** {"‚úÖ Messages properly reference business context" if cross_refs.get("scenario_to_messages", {}).get("referenced") else "‚ö†Ô∏è Messages need better scenario alignment"}

**Regulatory Consistency:** {"‚úÖ Consistent regulatory framework application" if cross_refs.get("regulatory_consistency") else "‚ö†Ô∏è Regulatory framework needs alignment"}"""
        
        content += "\n\n---"
        return content

    def _generate_frameworks_section(self, playbook_data: Dict[str, Any], corrected_data: Dict[str, Any]) -> str:
        """Generate comprehensive frameworks and tools section"""
        content = """## üõ†Ô∏è Frameworks and Validation Tools
### Practical Implementation Resources"""
        
        # Claim-to-proof framework
        framework = playbook_data.get("claim_to_proof_framework", {})
        if framework:
            content += f"""

### üîÑ {framework.get('framework_name', 'Claim-to-Proof Validation Framework')}

#### üìã Step-by-Step Process

{self._format_numbered_list(framework.get('steps', []))}

#### ‚ùì Validation Questions

{self._format_list_items(framework.get('validation_questions', []), "‚ùì")}

#### üìä Proof Requirements

{self._format_list_items(framework.get('proof_requirements', []), "üìã")}

#### ‚ö†Ô∏è Common Pitfalls to Avoid

{self._format_list_items(framework.get('common_pitfalls', []), "‚ö†Ô∏è")}

#### üí° Framework Examples

{self._format_list_items(framework.get('examples', []), "üí°")}"""
            
            # Tools needed
            tools_needed = framework.get('tools_needed', [])
            if tools_needed:
                content += f"""

#### üõ†Ô∏è Required Tools & Resources

{self._format_list_items(tools_needed, "üîß")}"""
            
            # Timelines
            timelines = framework.get('timelines', [])
            if timelines:
                content += f"""

#### ‚è∞ Implementation Timelines

{self._format_list_items(timelines, "üìÖ")}"""
        
        # Additional frameworks from corrections
        if corrected_data and corrected_data.get("general_guidelines"):
            content += f"""

### üìã Message Development Guidelines

{self._format_list_items(corrected_data["general_guidelines"], "‚úÖ")}"""
        
        content += "\n\n---"
        return content

    def _generate_compliance_section(self, playbook_data: Dict[str, Any], training_request: Dict[str, Any]) -> str:
        """Generate compliance guidelines section"""
        content = f"""## ‚úÖ Compliance Guidelines
### {training_request.get('regulatory_framework', 'Regulatory')} Framework Requirements"""
        
        # Compliance checklist
        checklist = playbook_data.get("compliance_checklist", {})
        if checklist:
            content += f"""

### üìã {checklist.get('checklist_name', 'Quick Compliance Checklist')}

#### üóÇÔ∏è Review Categories

{self._format_list_items(checklist.get('categories', []), "üìÅ")}

#### ‚ùì Validation Questions

{self._format_list_items(checklist.get('questions', []), "‚ùì")}

#### üö® Red Flags to Watch For

{self._format_list_items(checklist.get('red_flags', []), "üö®")}

#### ‚úÖ Approval Criteria

{self._format_list_items(checklist.get('approval_criteria', []), "‚úÖ")}"""
            
            # Escalation procedures
            escalation_procedures = checklist.get('escalation_procedures', [])
            if escalation_procedures:
                content += f"""

#### üÜò Escalation Procedures

{self._format_list_items(escalation_procedures, "üìû")}"""
            
            # Review frequency
            if checklist.get('review_frequency'):
                content += f"""

#### üîÑ Review Schedule

**Frequency:** {checklist['review_frequency']}"""
        
        # Do's and Don'ts
        dos_and_donts = playbook_data.get("dos_and_donts", [])
        if dos_and_donts:
            content += f"""

### ‚úÖ Do's and Don'ts Quick Reference

{self._format_list_items(dos_and_donts, "üìå")}"""
        
        # Greenwashing patterns
        greenwashing_patterns = playbook_data.get("greenwashing_patterns", [])
        if greenwashing_patterns:
            content += f"""

### üö´ Greenwashing Patterns to Avoid

{self._format_list_items(greenwashing_patterns, "üö´")}"""
        
        content += "\n\n---"
        return content

    def _generate_case_studies_section(self, playbook_data: Dict[str, Any], problematic_data: Dict[str, Any]) -> str:
        """Generate comprehensive case studies section"""
        content = """## üìñ Case Study Library
### Real-World Examples and Lessons Learned"""
        
        # Case studies from playbook
        case_studies = playbook_data.get("case_study_snapshots", [])
        
        if case_studies:
            for i, case in enumerate(case_studies, 1):
                message_type = case.get("message_type", "example")
                type_emoji = "‚úÖ" if "good" in message_type else "‚ùå" if "bad" in message_type else "üìã"
                
                content += f"""

### {type_emoji} Case Study #{i}: {case.get('title', 'Untitled Case')}

**Company:** {case.get('company_name', 'Anonymous')}  
**Example Type:** {message_type.replace('_', ' ').title()}

**Original Message:**
> "{case.get('original_message', 'Message not provided')}"

**üìä Analysis:**
{case.get('analysis', 'Analysis not available')}

**üéØ Key Lesson:**
{case.get('key_lesson', 'Key lesson not specified')}

**‚öñÔ∏è Regulatory Context:**
{case.get('regulatory_context', 'Regulatory context not provided')}"""
                
                # Outcome
                if case.get('outcome'):
                    content += f"""

**üìà Outcome:**
{case['outcome']}"""
                
                # Lessons learned
                lessons_learned = case.get('lessons_learned', [])
                if lessons_learned:
                    content += f"""

**üìö Detailed Lessons Learned:**
{self._format_list_items(lessons_learned, "üí°")}"""
        
        # Additional examples from problematic messages
        if problematic_data and problematic_data.get("problematic_messages"):
            content += """

### üì∞ Additional Real-World Examples from Analysis"""
            
            for i, message in enumerate(problematic_data["problematic_messages"], 1):
                real_world_examples = message.get("real_world_examples", [])
                if real_world_examples:
                    content += f"""

**Example Set #{i}:**
{self._format_list_items(real_world_examples, "üì∞")}"""
        
        content += "\n\n---"
        return content

    def _generate_implementation_section(self, playbook_data: Dict[str, Any], scenario_data: Dict[str, Any]) -> str:
        """Generate implementation roadmap section"""
        company_name = scenario_data.get("company_name", "your organization")
        
        content = f"""## üöÄ Implementation Roadmap
### Getting Started with Compliant Sustainability Messaging at {company_name}"""
        
        # Quick start guide
        quick_start = playbook_data.get("quick_start_guide", [])
        if quick_start:
            content += f"""

### üèÅ Quick Start Guide

{self._format_numbered_list(quick_start)}"""
        
        # Team training tips
        training_tips = playbook_data.get("team_training_tips", [])
        if training_tips:
            content += f"""

### üë• Team Training & Education

{self._format_list_items(training_tips, "üë®‚Äçüè´")}"""
        
        # Success stories
        success_stories = playbook_data.get("success_stories", [])
        if success_stories:
            content += f"""

### üèÜ Success Stories & Implementation Examples

{self._format_list_items(success_stories, "üéâ")}"""
        
        # Common mistakes
        common_mistakes = playbook_data.get("common_mistakes", [])
        if common_mistakes:
            content += f"""

### ‚ö†Ô∏è Common Implementation Mistakes to Avoid

{self._format_list_items(common_mistakes, "‚ö†Ô∏è")}"""
        
        content += "\n\n---"
        return content

    def _generate_regulatory_section(self, playbook_data: Dict[str, Any], training_request: Dict[str, Any]) -> str:
        """Generate regulatory reference section"""
        framework = training_request.get("regulatory_framework", "Global")
        
        content = f"""## üìÑ Regulatory Reference Guide
### {framework} Sustainability Messaging Requirements"""
        
        # Regulatory references
        regulatory_refs = playbook_data.get("regulatory_references", [])
        if regulatory_refs:
            content += f"""

### üìö Key Regulations & Standards

{self._format_list_items(regulatory_refs, "‚öñÔ∏è")}"""
        
        # Additional resources
        additional_resources = playbook_data.get("additional_resources", [])
        if additional_resources:
            content += f"""

### üîó Additional Learning Resources

{self._format_list_items(additional_resources, "üìñ")}"""
        
        content += "\n\n---"
        return content

    def _generate_quality_metrics_section(self, validation_result: Dict[str, Any], extracted_data: Dict[str, Any]) -> str:
        """Generate quality metrics and session information"""
        content = f"""## üìä Quality Metrics & Session Data
### Training Session Analysis & Validation Results

#### üéØ Overall Quality Assessment

**Quality Score:** {validation_result.get('quality_score', 0):.1f}/100  
**Data Completeness:** {validation_result.get('completeness_percentage', 0):.1f}%  
**Tasks Successfully Extracted:** {extracted_data.get('total_tasks_found', 0)}/4  
**Validation Status:** {"‚úÖ Passed" if validation_result.get('is_complete') else "‚ö†Ô∏è Needs Review"}

#### üìã Task-by-Task Validation"""
        
        task_validations = validation_result.get("task_validations", {})
        for task_name, validation in task_validations.items():
            score = validation.get("score", 0)
            issues = validation.get("issues", [])
            strengths = validation.get("strengths", [])
            
            status_emoji = "‚úÖ" if score >= 80 else "üü°" if score >= 60 else "üî¥"
            
            content += f"""

**{task_name.title()} Task {status_emoji}**
- Score: {score}/100
- Issues: {len(issues)} identified
- Strengths: {len(strengths)} found"""
            
            if issues:
                content += f"\n- Key Issues: {', '.join(issues[:3])}"
            if strengths:
                content += f"\n- Key Strengths: {', '.join(strengths[:3])}"
        
        # Data richness
        data_richness = validation_result.get("data_richness", {})
        if data_richness:
            content += f"""

#### üìä Data Richness Metrics

**Total Characters Extracted:** {data_richness.get('total_characters', 0):,}  
**Total Data Fields:** {data_richness.get('total_fields', 0):,}  
**Complex Structures:** {data_richness.get('nested_structures', 0)}  
**List Items:** {data_richness.get('list_items', 0):,}"""
        
        # Extraction log
        extraction_log = extracted_data.get("extraction_log", [])
        if extraction_log:
            content += f"""

#### üìù Extraction Process Log

{self._format_list_items(extraction_log[-10:], "üìã")}"""  # Show last 10 entries
        
        content += f"""

#### üîß Session Technical Details

**Session ID:** {self.session_id}  
**Generation Timestamp:** {self.generation_timestamp.isoformat()}  
**Processing Status:** {"‚úÖ Successful" if validation_result.get('is_complete') else "‚ö†Ô∏è Partial"}  
**Data Source:** Session-specific AI agent outputs with real-time validation

---"""
        
        return content

    def _generate_appendices_section(self, playbook_data: Dict[str, Any], extracted_data: Dict[str, Any]) -> str:
        """Generate appendices section"""
        content = """## üìö Appendices
### Reference Materials & Additional Information"""
        
        # Glossary
        glossary_terms = playbook_data.get("glossary_terms", [])
        if glossary_terms:
            content += f"""

### üìñ Glossary of Terms

{self._format_list_items(glossary_terms, "üìù")}"""
        
        # Contact resources
        contact_resources = playbook_data.get("contact_resources", [])
        if contact_resources:
            content += f"""

### üìû Contact Resources & Support

{self._format_list_items(contact_resources, "üìß")}"""
        
        # Data extraction summary
        content += f"""

### üîç Data Extraction Summary

**Session Processing Details:**
- Total Tasks Processed: {extracted_data.get('total_tasks_found', 0)}
- Extraction Success Rate: {('100%' if extracted_data.get('parsing_success') else 'Partial')}
- Data Validation: {"‚úÖ Passed" if extracted_data.get('parsing_success') else "‚ö†Ô∏è Review Required"}

**Content Statistics:**
- Scenario Data: {"‚úÖ Extracted" if extracted_data.get('scenario_data') else "‚ùå Missing"}
- Problematic Messages: {"‚úÖ Extracted" if extracted_data.get('problematic_messages') else "‚ùå Missing"}
- Corrected Messages: {"‚úÖ Extracted" if extracted_data.get('corrected_messages') else "‚ùå Missing"}
- Playbook Framework: {"‚úÖ Extracted" if extracted_data.get('playbook_data') else "‚ùå Missing"}

### üìÑ Document Metadata

**Generated by:** Sustainability Training AI v2.0  
**Generation Method:** Enhanced data extraction with validation  
**Content Verification:** Multi-layer validation with quality scoring  
**Compliance Framework:** Current regulatory requirements as of {datetime.now().year}  

---

*This playbook was generated using advanced AI agents with real-time data extraction, validation, and integration. All content is based on current best practices and regulatory requirements.*

**üå± Thank you for using our enhanced sustainability training system!**"""
        
        return content

    # Helper methods
    def _format_list_items(self, items: List[str], bullet: str = "‚Ä¢") -> str:
        """Format list items with custom bullets"""
        if not items:
            return "*No items available*"
        
        formatted_items = []
        for item in items:
            if isinstance(item, str) and item.strip():
                formatted_items.append(f"{bullet} {item}")
            elif not isinstance(item, str):
                formatted_items.append(f"{bullet} {str(item)}")
        
        return "\n".join(formatted_items) if formatted_items else "*No valid items available*"

    def _format_numbered_list(self, items: List[str]) -> str:
        """Format items as numbered list"""
        if not items:
            return "*No items available*"
        
        formatted_items = []
        for i, item in enumerate(items, 1):
            if isinstance(item, str) and item.strip():
                formatted_items.append(f"{i}. {item}")
        
        return "\n".join(formatted_items) if formatted_items else "*No valid items available*"

def generate_comprehensive_playbook(extracted_data: Dict[str, Any], 
                                  validation_result: Dict[str, Any],
                                  integration_result: Dict[str, Any],
                                  training_request: Dict[str, Any],
                                  session_id: str) -> str:
    """Main function to generate comprehensive markdown playbook"""
    formatter = MarkdownFormatter(session_id)
    return formatter.generate_comprehensive_markdown(
        extracted_data, 
        validation_result, 
        integration_result, 
        training_request
    )

def generate_summary_report(validation_result: Dict[str, Any], session_id: str) -> str:
    """Generate a quick summary report"""
    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    quality_score = validation_result.get('quality_score', 0)
    completeness = validation_result.get('completeness_percentage', 0)
    
    return f"""# Sustainability Training - Quick Summary Report

**Session ID:** {session_id}  
**Generated:** {timestamp}  
**Quality Score:** {quality_score:.1f}/100  
**Completeness:** {completeness:.1f}%  

## Status Overview
- **Overall Status:** {"‚úÖ Success" if validation_result.get('is_complete') else "‚ö†Ô∏è Partial"}
- **Tasks Extracted:** {len(validation_result.get('task_validations', {}))}
- **Issues Found:** {len(validation_result.get('overall_issues', []))}

## Next Steps
1. Review the comprehensive playbook
2. Implement recommended corrections
3. Validate messaging using provided frameworks
4. Train team on best practices

*Full detailed playbook available in the complete document.*
"""